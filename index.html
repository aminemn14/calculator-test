<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Calculatrice</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-indigo-50">
    <div class="flex h-screen">
      <!-- Sidebar Historique toujours visible -->
      <div
        class="bg-indigo-100 border-r border-indigo-300 w-64 p-4 overflow-y-auto"
      >
        <h2 class="text-2xl font-semibold mb-4 text-indigo-800">Historique</h2>
        <div id="historyList" class="space-y-2 text-indigo-900 text-sm"></div>
        <button
          id="clear-history"
          class="mt-4 w-full bg-red-500 text-white p-2 rounded hover:bg-red-600"
        >
          Effacer Historique
        </button>
      </div>

      <!-- Zone Calculatrice -->
      <div class="flex-1 flex flex-col items-center justify-center p-4">
        <!-- Écran d'affichage (largeur identique aux touches) -->
        <div
          class="w-full max-w-md bg-gray-800 text-indigo-300 font-mono text-3xl rounded-xl p-4 mb-6 shadow-lg"
        >
          <div id="calcDisplay" class="text-right min-h-[3rem] pt-1"></div>
        </div>

        <!-- Grille des boutons avec touches agrandies -->
        <div class="w-full grid grid-cols-4 gap-3 max-w-md">
          <!-- Ligne 1 : C et DEL, chacune occupant 2 colonnes -->
          <button
            class="calc-btn col-span-2 bg-indigo-200 hover:bg-indigo-300 p-6 rounded-xl text-indigo-800 font-bold text-2xl"
            data-action="clear"
          >
            C
          </button>
          <button
            class="calc-btn col-span-2 bg-indigo-200 hover:bg-indigo-300 p-6 rounded-xl text-indigo-800 font-bold text-2xl"
            data-action="delete"
          >
            DEL
          </button>

          <!-- Ligne 2 : 7, 8, 9, × -->
          <button
            class="calc-btn bg-indigo-100 hover:bg-indigo-200 p-6 rounded-xl text-indigo-800 font-bold text-2xl"
            data-value="7"
          >
            7
          </button>
          <button
            class="calc-btn bg-indigo-100 hover:bg-indigo-200 p-6 rounded-xl text-indigo-800 font-bold text-2xl"
            data-value="8"
          >
            8
          </button>
          <button
            class="calc-btn bg-indigo-100 hover:bg-indigo-200 p-6 rounded-xl text-indigo-800 font-bold text-2xl"
            data-value="9"
          >
            9
          </button>
          <button
            class="calc-btn bg-indigo-500 hover:bg-indigo-600 p-6 rounded-xl text-white font-bold text-2xl"
            data-action="multiply"
          >
            ×
          </button>

          <!-- Ligne 3 : 4, 5, 6, − -->
          <button
            class="calc-btn bg-indigo-100 hover:bg-indigo-200 p-6 rounded-xl text-indigo-800 font-bold text-2xl"
            data-value="4"
          >
            4
          </button>
          <button
            class="calc-btn bg-indigo-100 hover:bg-indigo-200 p-6 rounded-xl text-indigo-800 font-bold text-2xl"
            data-value="5"
          >
            5
          </button>
          <button
            class="calc-btn bg-indigo-100 hover:bg-indigo-200 p-6 rounded-xl text-indigo-800 font-bold text-2xl"
            data-value="6"
          >
            6
          </button>
          <button
            class="calc-btn bg-indigo-500 hover:bg-indigo-600 p-6 rounded-xl text-white font-bold text-2xl"
            data-action="subtract"
          >
            −
          </button>

          <!-- Ligne 4 : 1, 2, 3, + -->
          <button
            class="calc-btn bg-indigo-100 hover:bg-indigo-200 p-6 rounded-xl text-indigo-800 font-bold text-2xl"
            data-value="1"
          >
            1
          </button>
          <button
            class="calc-btn bg-indigo-100 hover:bg-indigo-200 p-6 rounded-xl text-indigo-800 font-bold text-2xl"
            data-value="2"
          >
            2
          </button>
          <button
            class="calc-btn bg-indigo-100 hover:bg-indigo-200 p-6 rounded-xl text-indigo-800 font-bold text-2xl"
            data-value="3"
          >
            3
          </button>
          <button
            class="calc-btn bg-indigo-500 hover:bg-indigo-600 p-6 rounded-xl text-white font-bold text-2xl"
            data-action="add"
          >
            +
          </button>

          <!-- Ligne 5 : 0, ., = -->
          <button
            class="calc-btn col-span-2 bg-indigo-100 hover:bg-indigo-200 p-6 rounded-xl text-indigo-800 font-bold text-2xl"
            data-value="0"
          >
            0
          </button>
          <button
            class="calc-btn bg-indigo-100 hover:bg-indigo-200 p-6 rounded-xl text-indigo-800 font-bold text-2xl"
            data-value="."
          >
            .
          </button>
          <button
            class="calc-btn bg-indigo-700 hover:bg-indigo-800 p-6 rounded-xl text-white font-bold text-2xl"
            data-action="calculate"
          >
            =
          </button>
        </div>
      </div>
    </div>

    <script>
      // Classe de la calculatrice basée sur une expression affichée
      class Calculator {
        constructor() {
          this.expression = "";
          this.history =
            JSON.parse(localStorage.getItem("calculatorHistory")) || [];
        }
        append(char) {
          const operators = ["+", "−", "×"];
          const lastChar = this.expression.slice(-1);
          // Si un opérateur est appuyé après un autre opérateur, remplace le dernier
          if (operators.includes(char) && operators.includes(lastChar)) {
            this.expression = this.expression.slice(0, -1) + char;
          } else {
            this.expression += char;
          }
        }
        clear() {
          this.expression = "";
        }
        delete() {
          this.expression = this.expression.slice(0, -1);
        }
        compute() {
          try {
            let expr = this.expression.replace(/×/g, "*").replace(/−/g, "-");
            // Conversion des nombres avec des zéros en tête en leur forme numérique standard
            expr = expr.replace(/\d+(\.\d+)?/g, (num) => String(Number(num)));
            let result = eval(expr);
            this.saveToHistory(this.expression, result);
            this.expression = result.toString();
          } catch (e) {
            this.expression = "Error";
          }
        }
        saveToHistory(expr, result) {
          const entry = { expr, result };
          this.history.push(entry);
          localStorage.setItem(
            "calculatorHistory",
            JSON.stringify(this.history)
          );
        }
      }

      const calculator = new Calculator();
      const display = document.getElementById("calcDisplay");
      const historyList = document.getElementById("historyList");

      function updateDisplay() {
        display.textContent = calculator.expression || "0";
      }

      function renderHistory() {
        historyList.innerHTML = "";
        if (calculator.history.length === 0) return;
        calculator.history.forEach((entry) => {
          const div = document.createElement("div");
          div.textContent = `${entry.expr} = ${entry.result}`;
          historyList.appendChild(div);
        });
      }

      document.querySelectorAll(".calc-btn").forEach((button) => {
        button.addEventListener("click", () => {
          if (button.dataset.value !== undefined) {
            // Bouton numérique ou point
            calculator.append(button.dataset.value);
            updateDisplay();
          } else if (button.dataset.action) {
            switch (button.dataset.action) {
              case "clear":
                calculator.clear();
                updateDisplay();
                break;
              case "delete":
                calculator.delete();
                updateDisplay();
                break;
              case "add":
                calculator.append("+");
                updateDisplay();
                break;
              case "subtract":
                calculator.append("−");
                updateDisplay();
                break;
              case "multiply":
                calculator.append("×");
                updateDisplay();
                break;
              case "calculate":
                calculator.compute();
                updateDisplay();
                renderHistory();
                break;
            }
          }
        });
      });

      document.getElementById("clear-history").addEventListener("click", () => {
        calculator.history = [];
        localStorage.removeItem("calculatorHistory");
        renderHistory();
      });

      updateDisplay();
      renderHistory();
    </script>
  </body>
</html>
